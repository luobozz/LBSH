#!/bin/bash
# ssh增强 用于保存会话快速登录
# 依赖列表
SCRIPT_VERSION="1.0.0"
SCRIPT_NAME="lb-ssh"
LBSH_HOME="$HOME/.lbsh"
LBSH_CONFIG_HOME="$LBSH_HOME/config"

LSSH_CONFIG_HOME="$LBSH_CONFIG_HOME/lssh"
LSSH_CONFIG_REMOTE_LIST="remote_list.config"
LSSH_CONFIG_REMOTE_LIST_MARK="re|"

function msg(){
    if [ "$1" == "log" ]
    then
        if [ "$2" == "error" ]
        then
            echo -e "[${SCRIPT_NAME}] $(date '+%Y-%m-%d %H:%M:%S') \e[31mERROR\e[0m: $3" 1>&2
        else
            echo "[${SCRIPT_NAME}] $(date '+%Y-%m-%d %H:%M:%S')  INFO: $2"
        fi
    else
        if [ "$1" == "error" ]
        then
            echo -e "\e[31mERROR:\e[0m $2"
        else
            echo "$*"
        fi
    fi
}

function getUuid(){
    uuid=`uuidgen`
    echo ${uuid//-/}
}

if [ "$1" == "" ] || [ "$1" == "-h" ]; then
    msg "   Usage: $0 [options] [command]"
    msg "          $0 use name or ip or id"
    msg " "
    msg "   Repositories: [sshpass]"
    msg " "
    msg "   Commands: "
    msg "          r,run            Connecting a ssh session"
    msg "          ls,list          Output all configured ssh sessions"
    msg "          ad               add a remote to remote list(only support single cmd now"
    msg "                           -a address,the remote host address"
    msg "                           -p port(default=22,the remote host port"
    msg "                           -w way(default=pwd,the authentication mode for accessing remote hosts(pwd or pk"
    msg "                           -k key,the key of authentication mode"
    msg "                           -n name(default=uuid,the custom name of remote host"
    msg " "
    msg "   Options: "
    msg "          <default>,-h     Output usage information"
    msg "          -v               Verbose mode"
elif [ "$1" == "ls" ] || [ "$1" == "list" ]; then
    cat $LSSH_CONFIG_HOME/$LSSH_CONFIG_REMOTE_LIST
elif [ "$1" == "ad" ]; then
    # TODO support single cmd now //like -n -ag -xx.
    cmdGrep="$(echo "$*"|grep -oE "\-[^\\s&^-]\s[^\\s&^-]+")"
    cmdGrepArr=(${cmdGrep})
    ip=""
    port="22"
    way="pwd"
    password=""
    name=""

    for(( i=0;i<${#cmdGrepArr[@]};i++)); do
        pm=${cmdGrepArr[i]}
        if [ "$pm" == "-a" ]; then
            ip="${cmdGrepArr[i+1]}"
        elif [ "$pm" == "-p" ]; then
            port="${cmdGrepArr[i+1]}"
        elif [ "$pm" == "-w" ]; then
            way="${cmdGrepArr[i+1]}"
        elif [ "$pm" == "-k" ]; then
            password="${cmdGrepArr[i+1]}"
        elif [ "$pm" == "-n" ]; then
            name="${cmdGrepArr[i+1]}"
        fi
    done;

    exist=`grep "$ip $port" $LSSH_CONFIG_HOME/$LSSH_CONFIG_REMOTE_LIST`
    if [ ${#exist} -le 0 ]; then
        uuid=`getUuid`
        if [ "$name" == "" ]; then
            name="$uuid"
        fi
        echo "$LSSH_CONFIG_REMOTE_LIST_MARK$uuid $ip $port $way $password $name" >> $LSSH_CONFIG_HOME/$LSSH_CONFIG_REMOTE_LIST
        msg "uuid=$uuid,ip=$ip,port=$port,way=$way,password=$password,name=$name)",successfully add into remote list.
    else
        msg "ip=$ip,port=$port) already exist,($exist),please use [ -ed (name or uuid) .. ] to modify it."
    fi

elif [ "$1" == "r" ] || [ "$1" == "run" ]; then
    msg "run"
elif [ "$1" == "-v" ]; then
    msg "${SCRIPT_NAME} version: v${SCRIPT_VERSION}"
else
    msg "$1 is not supported by ${SCRIPT_NAME}."
fi

# sshpass -p '123456' ssh shtf@192.168.1.46
